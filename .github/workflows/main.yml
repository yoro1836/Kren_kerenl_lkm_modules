name: Build LKM Module

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout kernel source code
        uses: actions/checkout@v4
        with:
          repository: yoro1836/Kren_kernel
          ref: S908EXXUBEXK5
          path: kernel_source

      - name: Checkout module source code
        uses: actions/checkout@v4
        with:
          repository: lwfinger/rtw88
          path: module_source

      - name: Set up build environment
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses-dev bison flex openssl libssl-dev dkms libelf-dev libudev-dev libpci-dev
          wget https://github.com/ZyCromerZ/Clang/releases/download/12.0.1-20230207-release/Clang-12.0.1-20230207.tar.gz -O toolchain.tar.xz
          mkdir toolchain
          tar -xJf toolchain.tar.xz -C toolchain
          export PATH=$PATH:$(pwd)/toolchain/bin
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-

      - name: Prepare kernel headers and build directory
        shell: bash
        working-directory: kernel_source
        run: |
          cp kernel_source/arch/arm64/configs/kren_defconfig .config
          make oldconfig
          make headers_install
          make modules_prepare

      - name: Compile LKM module
        shell: bash
        working-directory: module_source
        run: |
          make -j$(nproc) -C /lib/modules/5.10.234-kren/build M=$(pwd) modules

      - name: Upload LKM module artifact
        uses: actions/upload-artifact@v4
        with:
          name: rtw88.ko
          path: module_source/rtw88.ko
